<html><body bgcolor= "#D3D3D3"><div><pre>
<span style="color: #229954">// Copyright 2013 Joe Walnes and the websocketd team.</span><span style="color: #FFE6E6">
</span><span style="color: #229954">// All rights reserved.</span><span style="color: #FFE6E6">
</span><span style="color: #229954">// Use of this source code is governed by a BSD-style</span><span style="color: #FFE6E6">
</span><span style="color: #229954">// license that can be found in the LICENSE file.</span><span style="color: #FFE6E6">

</span><span style="color: #8B008B">package</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">main</span><span style="color: #FFE6E6">

</span><span style="color: #8B008B">import</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">(</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #00008B">"fmt"</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #00008B">"net/http"</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #00008B">"os"</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #00008B">"runtime"</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #00008B">"strconv"</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #00008B">"strings"</span><span style="color: #FFE6E6">

</span><span style="color: #FFE6E6">	</span><span style="color: #00008B">"github.com/joewalnes/websocketd/libwebsocketd"</span><span style="color: #FFE6E6">
</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #DB7093">sdafas</span><span style="color: #4B0082">=</span><span style="color: #00008B">'f'</span><span style="color: #FFE6E6">
</span><span style="color: #DB7093">dsss</span><span style="color: #4B0082">=</span><span style="color: #00008B">'\f'</span><span style="color: #FFE6E6">
</span><span style="color: #DB7093">teste</span><span style="color: #4B0082">=</span><span style="color: #DB7093">y</span><span style="color: #FFE6E6">
</span><span style="color: #DB7093">hfdush</span><span style="color: #4B0082">=</span><span style="color: #00008B">'\n'</span><span style="color: #FFE6E6">
</span><span style="color: #8B008B">func</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">logfunc</span><span style="color: #1E90FF">(</span><span style="color: #DB7093">l</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">*</span><span style="color: #DB7093">libwebsocketd</span><span style="color: #4B0082">.</span><span style="color: #DB7093">LogScope</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">level</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">libwebsocketd</span><span style="color: #4B0082">.</span><span style="color: #DB7093">LogLevel</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">levelName</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">string</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">category</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">string</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">msg</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">string</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">args</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">...</span><span style="color: #8B008B">interface</span><span style="color: #1E90FF">{</span><span style="color: #1E90FF">}</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">if</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">level</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082"><</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">l</span><span style="color: #4B0082">.</span><span style="color: #DB7093">MinLevel</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">return</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">fullMsg</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">:=</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">fmt</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Sprintf</span><span style="color: #1E90FF">(</span><span style="color: #DB7093">msg</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">args</span><span style="color: #4B0082">...</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">

</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">assocDump</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">:=</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">""</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">for</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">index</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">pair</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">:=</span><span style="color: #FFE6E6"> </span><span style="color: #8B008B">range</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">l</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Associated</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">if</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">index</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">></span><span style="color: #FFE6E6"> </span><span style="color: #008080">0</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">assocDump</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">+=</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">" "</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">assocDump</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">+=</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">fmt</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Sprintf</span><span style="color: #1E90FF">(</span><span style="color: #00008B">"%s:'%s'"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">pair</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Key</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">pair</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Value</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">

</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">l</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Mutex</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Lock</span><span style="color: #1E90FF">(</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">fmt</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Printf</span><span style="color: #1E90FF">(</span><span style="color: #00008B">"%s | %-6s | %-10s | %s | %s\n"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">libwebsocketd</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Timestamp</span><span style="color: #1E90FF">(</span><span style="color: #1E90FF">)</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">levelName</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">category</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">assocDump</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">fullMsg</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">l</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Mutex</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Unlock</span><span style="color: #1E90FF">(</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">

</span><span style="color: #8B008B">func</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">main</span><span style="color: #1E90FF">(</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">config</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">:=</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">parseCommandLine</span><span style="color: #1E90FF">(</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">

</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">log</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">:=</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">libwebsocketd</span><span style="color: #4B0082">.</span><span style="color: #DB7093">RootLogScope</span><span style="color: #1E90FF">(</span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">LogLevel</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">logfunc</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">

</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">if</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">DevConsole</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">if</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">StaticDir</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">!=</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">""</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">log</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Fatal</span><span style="color: #1E90FF">(</span><span style="color: #00008B">"server"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"Invalid parameters: --devconsole cannot be used with --staticdir. Pick one."</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">os</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Exit</span><span style="color: #1E90FF">(</span><span style="color: #008080">4</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">if</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">CgiDir</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">!=</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">""</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">log</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Fatal</span><span style="color: #1E90FF">(</span><span style="color: #00008B">"server"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"Invalid parameters: --devconsole cannot be used with --cgidir. Pick one."</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">os</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Exit</span><span style="color: #1E90FF">(</span><span style="color: #008080">4</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">

</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">if</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">runtime</span><span style="color: #4B0082">.</span><span style="color: #DB7093">GOOS</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">!=</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"windows"</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6"> </span><span style="color: #229954">// windows relies on env variables to find its libs... e.g. socket stuff</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">os</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Clearenv</span><span style="color: #1E90FF">(</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6"> </span><span style="color: #229954">// it's ok to wipe it clean, we already read env variables from passenv into config</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">handler</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">:=</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">libwebsocketd</span><span style="color: #4B0082">.</span><span style="color: #DB7093">NewWebsocketdServer</span><span style="color: #1E90FF">(</span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Config</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">log</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">MaxForks</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">http</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Handle</span><span style="color: #1E90FF">(</span><span style="color: #00008B">"/"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">handler</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">

</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">if</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">UsingScriptDir</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">log</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Info</span><span style="color: #1E90FF">(</span><span style="color: #00008B">"server"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"Serving from directory      : %s"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">ScriptDir</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6"> </span><span style="color: #8B008B">else</span><span style="color: #FFE6E6"> </span><span style="color: #8B008B">if</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">CommandName</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">!=</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">""</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">log</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Info</span><span style="color: #1E90FF">(</span><span style="color: #00008B">"server"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"Serving using application   : %s %s"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">CommandName</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">strings</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Join</span><span style="color: #1E90FF">(</span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">CommandArgs</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">" "</span><span style="color: #1E90FF">)</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">if</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">StaticDir</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">!=</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">""</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">log</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Info</span><span style="color: #1E90FF">(</span><span style="color: #00008B">"server"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"Serving static content from : %s"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">StaticDir</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">if</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">CgiDir</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">!=</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">""</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">log</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Info</span><span style="color: #1E90FF">(</span><span style="color: #00008B">"server"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"Serving CGI scripts from    : %s"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">CgiDir</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">

</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">rejects</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">:=</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">make</span><span style="color: #1E90FF">(</span><span style="color: #8B008B">chan</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">error</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #008080">1</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">for</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">_</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">addrSingle</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">:=</span><span style="color: #FFE6E6"> </span><span style="color: #8B008B">range</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Addr</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">log</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Info</span><span style="color: #1E90FF">(</span><span style="color: #00008B">"server"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"Starting WebSocket server   : %s"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">handler</span><span style="color: #4B0082">.</span><span style="color: #DB7093">TellURL</span><span style="color: #1E90FF">(</span><span style="color: #00008B">"ws"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">addrSingle</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"/"</span><span style="color: #1E90FF">)</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">if</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">DevConsole</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">log</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Info</span><span style="color: #1E90FF">(</span><span style="color: #00008B">"server"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"Developer console enabled   : %s"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">handler</span><span style="color: #4B0082">.</span><span style="color: #DB7093">TellURL</span><span style="color: #1E90FF">(</span><span style="color: #00008B">"http"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">addrSingle</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"/"</span><span style="color: #1E90FF">)</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6"> </span><span style="color: #8B008B">else</span><span style="color: #FFE6E6"> </span><span style="color: #8B008B">if</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">StaticDir</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">!=</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"" || config.CgiDir != "</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">log</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Info</span><span style="color: #1E90FF">(</span><span style="color: #00008B">"server"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"Serving CGI or static files : %s"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">handler</span><span style="color: #4B0082">.</span><span style="color: #DB7093">TellURL</span><span style="color: #1E90FF">(</span><span style="color: #00008B">"http"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">addrSingle</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"/"</span><span style="color: #1E90FF">)</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #229954">// ListenAndServe is blocking function. Let's run it in</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #229954">// go routine, reporting result to control channel.</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #229954">// Since it's blocking it'll never return non-error.</span><span style="color: #FFE6E6">

</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">go</span><span style="color: #FFE6E6"> </span><span style="color: #8B008B">func</span><span style="color: #1E90FF">(</span><span style="color: #DB7093">addr</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">string</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">if</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Ssl</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">rejects</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082"><-</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">http</span><span style="color: #4B0082">.</span><span style="color: #DB7093">ListenAndServeTLS</span><span style="color: #1E90FF">(</span><span style="color: #DB7093">addr</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">CertFile</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">KeyFile</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">nil</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6"> </span><span style="color: #8B008B">else</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">rejects</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082"><-</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">http</span><span style="color: #4B0082">.</span><span style="color: #DB7093">ListenAndServe</span><span style="color: #1E90FF">(</span><span style="color: #DB7093">addr</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">nil</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #1E90FF">(</span><span style="color: #DB7093">addrSingle</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">

</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">if</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">RedirPort</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">!=</span><span style="color: #FFE6E6"> </span><span style="color: #008080">0</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">go</span><span style="color: #FFE6E6"> </span><span style="color: #8B008B">func</span><span style="color: #1E90FF">(</span><span style="color: #DB7093">addr</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">string</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">pos</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">:=</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">strings</span><span style="color: #4B0082">.</span><span style="color: #DB7093">IndexByte</span><span style="color: #1E90FF">(</span><span style="color: #DB7093">addr</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">':'</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">rediraddr</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">:=</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">addr</span><span style="color: #1E90FF">[</span><span style="color: #4B0082">:</span><span style="color: #DB7093">pos</span><span style="color: #1E90FF">]</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">+</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">":"</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">+</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">strconv</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Itoa</span><span style="color: #1E90FF">(</span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">RedirPort</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6"> </span><span style="color: #229954">// it would be silly to optimize this one</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">redir</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">:=</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">&</span><span style="color: #DB7093">http</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Server</span><span style="color: #1E90FF">{</span><span style="color: #DB7093">Addr</span><span style="color: #4B0082">:</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">rediraddr</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">Handler</span><span style="color: #4B0082">:</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">http</span><span style="color: #4B0082">.</span><span style="color: #DB7093">HandlerFunc</span><span style="color: #1E90FF">(</span><span style="color: #8B008B">func</span><span style="color: #1E90FF">(</span><span style="color: #DB7093">w</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">http</span><span style="color: #4B0082">.</span><span style="color: #DB7093">ResponseWriter</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">r</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">*</span><span style="color: #DB7093">http</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Request</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">

</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #229954">// redirect to same hostname as in request but different port and probably schema</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">uri</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">:=</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"https://"</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">if</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">!</span><span style="color: #DB7093">config</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Ssl</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">uri</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">=</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"http://"</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">uri</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">+=</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">r</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Host</span><span style="color: #1E90FF">[</span><span style="color: #4B0082">:</span><span style="color: #DB7093">strings</span><span style="color: #4B0082">.</span><span style="color: #DB7093">IndexByte</span><span style="color: #1E90FF">(</span><span style="color: #DB7093">r</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Host</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">':'</span><span style="color: #1E90FF">)</span><span style="color: #1E90FF">]</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">+</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">addr</span><span style="color: #1E90FF">[</span><span style="color: #DB7093">pos</span><span style="color: #4B0082">:</span><span style="color: #1E90FF">]</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">+</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"/"</span><span style="color: #FFE6E6">

</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">http</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Redirect</span><span style="color: #1E90FF">(</span><span style="color: #DB7093">w</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">r</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">uri</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">http</span><span style="color: #4B0082">.</span><span style="color: #DB7093">StatusMovedPermanently</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #1E90FF">)</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">log</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Info</span><span style="color: #1E90FF">(</span><span style="color: #00008B">"server"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"Starting redirect server   : http://%s/"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">rediraddr</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">rejects</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082"><-</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">redir</span><span style="color: #4B0082">.</span><span style="color: #DB7093">ListenAndServe</span><span style="color: #1E90FF">(</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #1E90FF">(</span><span style="color: #DB7093">addrSingle</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">select</span><span style="color: #FFE6E6"> </span><span style="color: #1E90FF">{</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #8B008B">case</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">err</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082">:=</span><span style="color: #FFE6E6"> </span><span style="color: #4B0082"><-</span><span style="color: #DB7093">rejects</span><span style="color: #4B0082">:</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">log</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Fatal</span><span style="color: #1E90FF">(</span><span style="color: #00008B">"server"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #00008B">"Can't start server: %s"</span><span style="color: #4B0082">,</span><span style="color: #FFE6E6"> </span><span style="color: #DB7093">err</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #FFE6E6">	</span><span style="color: #DB7093">os</span><span style="color: #4B0082">.</span><span style="color: #DB7093">Exit</span><span style="color: #1E90FF">(</span><span style="color: #008080">3</span><span style="color: #1E90FF">)</span><span style="color: #FFE6E6">
</span><span style="color: #FFE6E6">	</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">
</span><span style="color: #1E90FF">}</span><span style="color: #FFE6E6">
</span></pre></div></body></html>